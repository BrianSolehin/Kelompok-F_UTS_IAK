<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Katalog Produk</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    * { font-family: 'Inter', sans-serif; }

    @media (min-width: 1024px) {
      .layout { display: grid; grid-template-columns: 280px 1fr; gap: 0; }
      .sidebar { height: 100vh; position: sticky; top: 0; align-self: start; }
    }

    .nav-link { transition: all 0.2s ease; }
    .nav-link:hover { transform: translateX(4px); }
    .nav-link.active { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .skeleton { position: relative; overflow: hidden; background: #f3f4f6; }
    .skeleton::after {
      content: ""; position: absolute; inset: 0; transform: translateX(-100%);
      background: linear-gradient(90deg, rgba(243,244,246,0) 0%, rgba(229,231,235,.9) 50%, rgba(243,244,246,0) 100%);
      animation: shimmer 1.2s infinite;
    }
    @keyframes shimmer { 100% { transform: translateX(100%); } }

    .card-modern {
      background: white;
      border-radius: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      border: 1px solid rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(102, 126, 234, 0.4);
    }

    .sidebar-gradient { background: linear-gradient(180deg, #ffffff 0%, #f9fafb 100%); }
    .drawer-overlay { backdrop-filter: blur(4px); background: rgba(0, 0, 0, 0.3); }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
  <div class="layout">
    <!-- ===== Sidebar ===== -->
    <aside class="sidebar sidebar-gradient border-r border-gray-200">
      <div class="p-6 border-b border-gray-200">
        <div class="flex items-center gap-3 mb-2">
          <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center text-white font-bold text-lg">R</div>
          <div>
            <div class="text-lg font-bold text-gray-800">Retail Dashboard</div>
            <div class="text-xs text-gray-500">Management System</div>
          </div>
        </div>
      </div>

      <nav class="p-3 space-y-2">
        <a href="/ui" class="nav-link flex items-center gap-3 rounded-xl px-4 py-3 text-gray-700 hover:bg-gray-100">
          <span class="text-xl">üì¶</span> <span class="font-medium">Supplier</span>
        </a>
        <a href="/ui/tracking" class="nav-link flex items-center gap-3 rounded-xl px-4 py-3 text-gray-700 hover:bg-gray-100">
          <span class="text-xl">üöö</span> <span class="font-medium">Tracking</span>
        </a>
        <a href="/ui/pos" class="nav-link flex items-center gap-3 rounded-xl px-4 py-3 text-gray-700 hover:bg-gray-100">
          <span class="text-xl">üßæ</span> <span class="font-medium">Transaksi (POS)</span>
        </a>
        <a href="/ui/gudang" class="nav-link flex items-center gap-3 rounded-xl px-4 py-3 text-gray-700 hover:bg-gray-100">
          <span class="text-xl">üè¨</span> <span class="font-medium">Gudang</span>
        </a>
        <a href="/ui/history" class="nav-link flex items-center gap-3 rounded-xl px-4 py-3 text-gray-700 hover:bg-gray-100">
          <span class="text-xl">üìú</span> <span class="font-medium">History</span>
        </a>
      </nav>

      <div class="mt-auto p-4 border-t border-gray-200">
        <div class="text-xs text-gray-400 text-center">¬© 2025 Retail App</div>
      </div>
    </aside>

    <!-- ===== Main Content ===== -->
    <main class="min-h-screen">
      <div class="max-w-7xl mx-auto p-8 space-y-6">
        <div>
          <h1 class="text-3xl font-bold bg-gradient-to-r from-purple-600 to-indigo-600 bg-clip-text text-transparent mb-2">Katalog Produk</h1>
          <p class="text-gray-500">Kelola dan pesan produk dari supplier</p>
        </div>

        <!-- Control Bar -->
        <div class="card-modern p-6">
          <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 items-end">
            <div class="lg:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-2">Sumber Data</label>
              <select id="sourceSel" class="w-full px-4 py-2.5 rounded-xl border-2 border-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                <option value="supplier">Supplier</option>
                <option value="supplier2">Supplier2</option>
              </select>
            </div>

            <div class="lg:col-span-3">
              <label for="supplierIdInput" class="block text-sm font-medium text-gray-700 mb-2">ID Supplier</label>
              <input id="supplierIdInput" type="text" placeholder="contoh: 2"
                     class="w-full px-4 py-2.5 rounded-xl border-2 border-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" />
            </div>

            <div class="lg:col-span-5">
              <label class="block text-sm font-medium text-gray-700 mb-2">Cari Produk</label>
              <input id="searchInput" type="search" placeholder="üîç Cari nama / ID / kategori / deskripsi‚Ä¶"
                     class="w-full px-4 py-2.5 rounded-xl border-2 border-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" />
            </div>

            <div class="lg:col-span-2">
              <button id="refreshBtn" class="btn-primary w-full px-4 py-2.5 rounded-xl text-white font-medium shadow-lg">üîÑ Refresh</button>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
            <select id="sortSel" class="px-4 py-2.5 rounded-xl border-2 border-gray-200 focus:ring-2 focus:ring-purple-500 transition-all">
              <option value="nama_product">Sort: Nama</option>
              <option value="harga">Sort: Harga</option>
              <option value="stok">Sort: Stok</option>
              <option value="expired_date">Sort: Expired</option>
              <option value="kategori">Sort: Kategori</option>
            </select>

            <button id="bulkAddBtn" class="px-4 py-2.5 rounded-xl bg-gradient-to-r from-amber-500 to-orange-600 text-white font-medium hover:shadow-lg transition-all">‚ûï Tambah Terpilih</button>

            <button id="openCartBtn" class="px-4 py-2.5 rounded-xl bg-gradient-to-r from-emerald-500 to-green-600 text-white font-medium hover:shadow-lg transition-all">üõí Keranjang (<span id="cartCount">0</span>)</button>
          </div>
        </div>

        <!-- Table -->
        <div class="card-modern overflow-hidden">
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-gradient-to-r from-gray-50 to-gray-100" id="thead"></thead>
              <tbody id="tbody" class="divide-y divide-gray-100"></tbody>
            </table>
            <div id="tableSkeleton" class="hidden p-6">
              <div class="h-6 w-40 mb-3 skeleton rounded"></div>
              <div class="space-y-2">
                <div class="h-10 skeleton rounded"></div>
                <div class="h-10 skeleton rounded"></div>
                <div class="h-10 skeleton rounded"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Status -->
        <p id="status" class="text-sm text-gray-600 px-4 py-3 bg-white rounded-xl border border-gray-200"></p>
      </div>
    </main>
  </div>

  <!-- Drawer Keranjang -->
  <div id="cartOverlay" class="fixed inset-0 drawer-overlay hidden z-40" onclick="closeCart()"></div>
  <aside id="cartDrawer" class="fixed right-0 top-0 h-screen w-full sm:w-[480px] bg-white shadow-2xl translate-x-full transition-transform z-50">
    <div class="sticky top-0 z-10 bg-gradient-to-r from-purple-600 to-indigo-600 p-6 flex items-center justify-between">
      <div>
        <h2 class="text-xl font-bold text-white">Keranjang Belanja</h2>
        <p class="text-purple-100 text-sm">Review pesanan Anda</p>
      </div>
      <button id="closeCartBtn" class="text-white hover:bg-white/20 rounded-lg p-2 transition-all">‚úï</button>
    </div>

    <div class="px-6 pb-44 overflow-y-auto h-[calc(100vh-120px)]" id="cartScroll">
      <div class="space-y-3 pt-4" id="cartItems"></div>

      <!-- ===== Pilih Distributor ===== -->
      <section id="cartDist" class="mt-8 hidden">
        <header class="flex items-center justify-between mb-4">
          <div>
            <h3 class="text-lg font-semibold text-gray-800">Pilih Distributor</h3>
            <p id="cartDistInfo" class="text-sm text-gray-500">Pilih opsi pengiriman</p>
          </div>
          <span id="cartDistOrder" class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-lg"></span>
        </header>

        <div id="cartDistLoading" class="hidden mt-3 rounded-xl border-2 border-dashed border-gray-300 p-6 text-center text-gray-600">
          <div class="w-8 h-8 border-3 border-purple-500 border-t-transparent rounded-full animate-spin mx-auto mb-2"></div>
          Memuat opsi distributor‚Ä¶
        </div>

        <div id="cartDistEmpty" class="hidden mt-3 rounded-xl border-2 border-dashed border-gray-300 p-6 text-center text-gray-600">
          Belum ada opsi distributor untuk order ini.
          <button id="reloadDistBtnEmpty" class="ml-2 text-purple-600 underline font-medium">Muat ulang</button>
        </div>

        <div id="cartDistOptions" class="mt-3 space-y-3"></div>

        <div class="mt-4 flex items-center gap-3">
          <button id="reloadDistBtn" class="px-4 py-2.5 rounded-xl border-2 border-gray-200 hover:bg-gray-50 transition-all font-medium">üîÑ Muat ulang</button>
          <button id="confirmDistBtn" class="flex-1 px-4 py-2.5 btn-primary text-white rounded-xl disabled:opacity-50 disabled:cursor-not-allowed font-medium shadow-lg" disabled>‚úì Konfirmasi Distributor</button>
        </div>
      </section>

      <!-- ===== Info Resi ===== -->
      <section id="cartResi" class="hidden mt-8 border-2 border-green-200 rounded-xl p-4 bg-green-50">
        <h3 class="font-semibold text-green-800 mb-2">‚úì Informasi Pengiriman</h3>
        <div id="cartResiInfo" class="text-sm text-green-700"></div>
      </section>
    </div>

    <div class="fixed right-0 bottom-0 w-full sm:w-[480px] bg-white border-t-2 border-gray-200 p-6 space-y-4 shadow-lg">
      <div class="flex items-center justify-between">
        <span class="font-semibold text-gray-700">Total Pembayaran</span>
        <span id="cartTotal" class="font-bold text-2xl text-purple-600">Rp 0</span>
      </div>
      <div class="flex gap-3">
        <button id="clearCartBtn" class="px-4 py-3 rounded-xl border-2 border-gray-200 hover:bg-gray-50 font-medium transition-all w-1/3">üóëÔ∏è Clear</button>
        <button id="checkoutBtn" class="px-4 py-3 rounded-xl btn-primary text-white font-medium shadow-lg w-2/3">üí≥ Checkout</button>
      </div>
      <small class="text-gray-500 block text-center">Pastikan ID Supplier sudah terisi</small>
    </div>
  </aside>

  <!-- ======= SCRIPT ======= -->
  <script>
    (function markActive(){
      const path = window.location.pathname;
      document.querySelectorAll('.nav-link').forEach(a => {
        const href = a.getAttribute('href');
        if (href === '/ui' && (path === '/ui' || path === '/ui/supplier')) a.classList.add('active');
        if (href === path) a.classList.add('active');
      });
    })();

    const ENDPOINTS = {
      supplier:  "/api/supplier/products",
      supplier2: "/api/supplier2/products",
    };
    const BACKEND_CHECKOUT      = "/api/orders/checkout";
    const BACKEND_DRAFT_LATEST  = "/api/orders/drafts/latest";
    const BACKEND_DRAFT_BY_ID   = (id) => `/api/orders/drafts/${id}`;
    const BACKEND_CHOOSE        = (id) => `/api/orders/drafts/${id}/choose`;

    const tbody = document.getElementById("tbody");
    const thead = document.getElementById("thead");
    const tableSkeleton = document.getElementById("tableSkeleton");
    const searchInput = document.getElementById("searchInput");
    const sortSel = document.getElementById("sortSel");
    const statusEl = document.getElementById("status");
    const refreshBtn = document.getElementById("refreshBtn");
    const sourceSel = document.getElementById("sourceSel");
    const supplierIdInput = document.getElementById("supplierIdInput");

    const cartDrawer = document.getElementById("cartDrawer");
    const cartOverlay = document.getElementById("cartOverlay");
    const openCartBtn = document.getElementById("openCartBtn");
    const closeCartBtn = document.getElementById("closeCartBtn");
    const cartItemsEl = document.getElementById("cartItems");
    const cartTotalEl = document.getElementById("cartTotal");
    const cartCountEl = document.getElementById("cartCount");
    const clearCartBtn = document.getElementById("clearCartBtn");
    const checkoutBtn = document.getElementById("checkoutBtn");
    const bulkAddBtn = document.getElementById("bulkAddBtn");

    const cartDist = document.getElementById("cartDist");
    const cartDistOrder = document.getElementById("cartDistOrder");
    const cartDistOptions = document.getElementById("cartDistOptions");
    const cartDistInfo = document.getElementById("cartDistInfo");
    const cartDistLoading = document.getElementById("cartDistLoading");
    const cartDistEmpty = document.getElementById("cartDistEmpty");
    const reloadDistBtn = document.getElementById("reloadDistBtn");
    const reloadDistBtnEmpty = document.getElementById("reloadDistBtnEmpty");
    const confirmDistBtn = document.getElementById("confirmDistBtn");

    const cartResi = document.getElementById("cartResi");
    const cartResiInfo = document.getElementById("cartResiInfo");

    let DATA = [];
    let CACHE_LAST_GOOD = [];
    let CURRENT_SOURCE = sourceSel.value;
    window.currentOrderId = null;

    let lastLoadId = 0;
    let currentAbort = null;

    const rupiah = n => new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR", maximumFractionDigits: 0 }).format(n ?? 0);

    function renderHeader() {
      const isSupplier2 = CURRENT_SOURCE === "supplier2";
      thead.innerHTML = `
        <tr>
          <th class="p-4 text-center"><input id="chkAll" type="checkbox" class="w-4 h-4 rounded" /></th>
          <th class="text-left p-4 font-semibold text-gray-700">ID</th>
          <th class="text-left p-4 font-semibold text-gray-700">Nama</th>
          ${isSupplier2 ? '<th class="text-left p-4 font-semibold text-gray-700">Kategori</th>' : ''}
          <th class="text-right p-4 font-semibold text-gray-700">Harga</th>
          <th class="text-right p-4 font-semibold text-gray-700">Stok</th>
          ${isSupplier2 ? '<th class="text-left p-4 font-semibold text-gray-700">Deskripsi</th>' : '<th class="text-left p-4 font-semibold text-gray-700">Expired</th>'}
          <th class="text-center p-4 font-semibold text-gray-700 w-28">Qty</th>
          <th class="text-center p-4 font-semibold text-gray-700">Aksi</th>
        </tr>
      `;
      setTimeout(() => {
        const chkAll = document.getElementById("chkAll");
        if (chkAll) chkAll.addEventListener("change", (e) => {
          document.querySelectorAll(".rowChk").forEach(c => c.checked = e.target.checked);
        });
      }, 0);
    }

    function render() {
      const q = searchInput.value.trim().toLowerCase();
      let rows = DATA.filter(d =>
        (String(d.nama_product || "").toLowerCase().includes(q)) ||
        (String(d.id_product || "").toLowerCase().includes(q)) ||
        (String(d.kategori || "").toLowerCase().includes(q)) ||
        (String(d.deskripsi || "").toLowerCase().includes(q)) ||
        (String(d.expired_date || "").toLowerCase().includes(q))
      );

      const key = sortSel.value;
      rows.sort((a,b) => {
        if (["harga","stok"].includes(key)) return (a[key] ?? 0) - (b[key] ?? 0);
        return String(a[key] ?? "").localeCompare(String(b[key] ?? ""));
      });

      const isSupplier2 = CURRENT_SOURCE === "supplier2";
      tbody.innerHTML = rows.map(item => `
        <tr class="hover:bg-purple-50 transition-colors">
          <td class="p-4 text-center">
            <input class="rowChk w-4 h-4 rounded" type="checkbox" data-id="${item.id_product}">
          </td>
          <td class="p-4">
            <span class="px-3 py-1 bg-gray-100 rounded-lg font-mono text-xs">${item.id_product ?? ""}</span>
          </td>
          <td class="p-4 font-medium text-gray-800">${item.nama_product ?? ""}</td>
          ${isSupplier2 ? `<td class="p-4 text-gray-600">${item.kategori ?? "-"}</td>` : ""}
          <td class="p-4 text-right font-semibold text-gray-800">${rupiah(item.harga)}</td>
          <td class="p-4 text-right font-semibold ${item.stok < 10 ? 'text-red-600' : 'text-green-600'}">${item.stok ?? 0}</td>
          ${isSupplier2
            ? `<td class="p-4 text-gray-600 text-sm">${item.deskripsi ?? "-"}</td>`
            : `<td class="p-4 text-gray-600 text-sm">${item.expired_date ?? "-"}</td>`}
          <td class="p-4 text-center">
            <input type="number" min="1" max="${item.stok ?? 999999}" value="1"
                   class="qtyInput w-20 px-3 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                   data-id="${item.id_product}">
          </td>
          <td class="p-4 text-center">
            <button class="px-4 py-2 rounded-lg bg-gradient-to-r from-emerald-500 to-green-600 text-white font-medium hover:shadow-lg transition-all"
              onclick='addToCart(${JSON.stringify(item.id_product)}, ${JSON.stringify(item.nama_product)}, ${JSON.stringify(item.harga)}, ${JSON.stringify(item.stok)}, getQty("${item.id_product}"))'>
              + Tambah
            </button>
          </td>
        </tr>
      `).join("");

      statusEl.textContent = `${rows.length} item ditampilkan dari ${CURRENT_SOURCE}${q ? ` (filter: "${q}")` : ""}`;
    }

    async function load() {
      tableSkeleton.classList.remove('hidden');
      if (currentAbort) { try { currentAbort.abort(); } catch (_) {} }
      const aborter = new AbortController();
      currentAbort = aborter;
      const myLoadId = ++lastLoadId;

      try {
        const url = ENDPOINTS[CURRENT_SOURCE];
        const res = await fetch(url, { headers: { "Accept": "application/json" }, signal: aborter.signal });
        const json = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(json?.error ? `${json.error}: ${json.detail || ""}` : `HTTP ${res.status}`);

        if (myLoadId !== lastLoadId) return;

        let incoming = Array.isArray(json) ? json : (json.data || json.items || json.products || []);
        if (!Array.isArray(incoming)) incoming = [];
        DATA = incoming;
        CACHE_LAST_GOOD = incoming;
        renderHeader();
        render();
        statusEl.textContent = `Data termuat dari ${CURRENT_SOURCE} (${DATA.length} item).`;
      } catch (e) {
        if (myLoadId !== lastLoadId) return;
        console.error(e);
        statusEl.textContent = "Gagal memuat data: " + (e?.message || e);
        if (CACHE_LAST_GOOD.length) {
          DATA = CACHE_LAST_GOOD;
          renderHeader();
          render();
        } else {
          DATA = [];
          renderHeader();
          const isSupplier2 = CURRENT_SOURCE === 'supplier2';
          const colCount = isSupplier2 ? 9 : 8; // menyesuaikan jumlah kolom dinamis
          tbody.innerHTML = `<tr><td class="p-8 text-center text-gray-500" colspan="${colCount}">Tidak ada data.</td></tr>`;
        }
      } finally {
        if (myLoadId === lastLoadId) tableSkeleton.classList.add('hidden');
      }
      await refreshCart();
    }

    function getQty(id) {
      const el = document.querySelector(`.qtyInput[data-id="${CSS.escape(String(id))}"]`);
      let q = parseInt(el?.value || "1", 10);
      if (isNaN(q) || q <= 0) q = 1;
      const max = parseInt(el?.getAttribute("max") || "0", 10);
      if (max && q > max) q = max;
      return q;
    }

    function findItemById(id) { return DATA.find(d => String(d.id_product) === String(id)); }

    function openCart() { cartDrawer.style.transform = "translateX(0)"; cartOverlay.classList.remove('hidden'); }
    function closeCart() { cartDrawer.style.transform = "translateX(100%)"; cartOverlay.classList.add('hidden'); }

    async function refreshCart() {
      const res = await fetch("/api/cart/", { credentials: "same-origin", headers: { "Accept": "application/json" }});
      const json = await res.json().catch(() => ({items:[], total:0}));
      const items = json.items || [];

      cartItemsEl.innerHTML = items.map(it => `
        <div class="flex items-center justify-between border-2 border-gray-200 rounded-xl p-4 hover:border-purple-300 transition-all">
          <div class="min-w-0 flex-1">
            <div class="font-semibold text-gray-800 truncate">${it.nama_product}</div>
            <div class="text-xs text-gray-500 mt-1">ID: ${it.id_product} ‚Ä¢ Stok: ${it.stok}</div>
            <div class="text-sm text-purple-600 font-medium mt-1">${rupiah(it.harga)} √ó ${it.qty}</div>
          </div>
          <div class="flex items-center gap-2 ml-3">
            <button class="w-8 h-8 border-2 border-gray-200 rounded-lg hover:bg-gray-100 font-bold transition-all" onclick='updateQty(${JSON.stringify(it.id_product)}, ${Math.max(0,(it.qty-1))})'>‚àí</button>
            <span class="w-8 text-center font-semibold">${it.qty}</span>
            <button class="w-8 h-8 border-2 border-gray-200 rounded-lg hover:bg-gray-100 font-bold transition-all" onclick='updateQty(${JSON.stringify(it.id_product)}, ${it.qty+1})'>+</button>
          </div>
        </div>
      `).join("") || '<div class="text-center text-gray-500 py-8">üõí<br>Keranjang kosong</div>';

      cartTotalEl.textContent = rupiah(json.total || 0);
      cartCountEl.textContent = items.reduce((a,b)=>a+(b.qty||0),0);
    }

    async function addToCart(id_product, nama_product, harga, stok, qty=1) {
      const res = await fetch("/api/cart/add", {
        method: "POST",
        credentials: "same-origin",
        headers: {"Content-Type":"application/json","Accept":"application/json"},
        body: JSON.stringify({ id_product, nama_product, harga, stok, qty })
      });
      if (!res.ok) {
        const e = await res.json().catch(()=>({}));
        statusEl.textContent = "Gagal tambah ke keranjang: " + (e.error || res.status);
        return;
      }
      await refreshCart();
      statusEl.textContent = `‚úì Ditambahkan: ${nama_product} (√ó${qty})`;
      openCart();
    }

    async function bulkAddSelected() {
      const ids = [...document.querySelectorAll(".rowChk:checked")].map(c => c.dataset.id);
      if (!ids.length) { statusEl.textContent = "Pilih item terlebih dahulu"; return; }

      const items = ids.map(id => {
        const it = findItemById(id) || {};
        return {
          id_product: it.id_product,
          nama_product: it.nama_product,
          harga: it.harga,
          stok: it.stok,
          qty: getQty(id)
        };
      });

      const res = await fetch("/api/cart/bulk_add", {
        method: "POST",
        credentials: "same-origin",
        headers: {"Content-Type":"application/json","Accept":"application/json"},
        body: JSON.stringify({ items })
      });
      const json = await res.json().catch(()=>({}));
      if (!res.ok) { statusEl.textContent = "Gagal tambah massal: " + (json.error || res.status); return; }
      await refreshCart();
      statusEl.textContent = `‚úì ${items.length} item ditambahkan ke keranjang`;
      openCart();
    }

    async function updateQty(id_product, qty) {
      const res = await fetch("/api/cart/update", {
        method: "POST",
        credentials: "same-origin",
        headers: {"Content-Type":"application/json","Accept":"application/json"},
        body: JSON.stringify({ id_product, qty })
      });
      if (!res.ok) return;
      await refreshCart();
    }

    async function clearCart() {
      await fetch("/api/cart/clear", { method: "POST", credentials: "same-origin" });
      await refreshCart();
    }

    const show = el => el.classList.remove('hidden');
    const hide = el => el.classList.add('hidden');

    function distCardHTML(dist) {
      const code = dist.code || dist.id_distributor || '';
      const name = dist.name || dist.nama_distributor || '-';
      const service = dist.service || dist.layanan || 'Reguler';
      const fee = dist.fee ?? dist.harga_pengiriman ?? dist.harga ?? 0;
      const eta = dist.eta_text ?? dist.estimasi ?? '-';
      const note = dist.note || '';
      const feeFmt = new Intl.NumberFormat('id-ID').format(fee);

      return `
        <label class="flex gap-4 items-start rounded-xl border-2 border-gray-200 p-4 hover:border-purple-400 hover:bg-purple-50 cursor-pointer transition-all">
          <input type="radio" name="distChoice" value="${code}" class="mt-1 w-4 h-4" />
          <div class="flex-1">
            <div class="flex items-center justify-between mb-1">
              <p class="font-semibold text-gray-800">${name}</p>
              <p class="text-lg font-bold text-purple-600">Rp ${feeFmt}</p>
            </div>
            <p class="text-sm text-gray-600">${service} ‚Ä¢ ${eta}</p>
            ${note ? `<p class="text-xs text-gray-500 mt-2 bg-gray-50 px-2 py-1 rounded">${note}</p>` : ''}
            <p class="text-xs text-gray-400 mt-1">Kode: ${code}</p>
          </div>
        </label>
      `;
    }

    function renderDistributors(options = []) {
      cartDistOptions.innerHTML = options.map(o => distCardHTML(o)).join('');
      const radios = cartDistOptions.querySelectorAll('input[type="radio"]');
      confirmDistBtn.disabled = true;
      radios.forEach(r => r.addEventListener('change', () => { confirmDistBtn.disabled = false; }));
    }

    function showCartDistributor({ orderId, options, loading }) {
      show(cartDist);
      cartDistOrder.textContent = orderId ? `Order #${orderId}` : '';
      cartDistInfo.textContent = 'Pilih salah satu opsi untuk melanjutkan.';
      if (loading) {
        show(cartDistLoading); hide(cartDistEmpty); cartDistOptions.innerHTML = '';
        confirmDistBtn.disabled = true; return;
      }
      hide(cartDistLoading);
      if (!options || !options.length) {
        show(cartDistEmpty); cartDistOptions.innerHTML = ''; confirmDistBtn.disabled = true;
      } else {
        hide(cartDistEmpty); renderDistributors(options);
      }
    }

    async function fetchAndShowDistributors(orderId) {
      showCartDistributor({ orderId, loading: true });
      try {
        const res = await fetch(BACKEND_DRAFT_BY_ID(orderId), { headers: {"Accept":"application/json"} });
        const d = await res.json();
        let opts = Array.isArray(d.distributor_options) ? d.distributor_options : [];
        if (!opts.length && d._raw && Array.isArray(d._raw.distributor_options)) {
          opts = d._raw.distributor_options;
        }
        showCartDistributor({ orderId, options: opts, loading: false });
      } catch (e) {
        showCartDistributor({ orderId, options: [], loading: false });
        alert('Gagal memuat opsi distributor.');
      }
    }

    async function confirmDistributor(orderId) {
      const checked = document.querySelector('#cartDistOptions input[type="radio"]:checked');
      if (!checked) return;
      const code = checked.value;
      const res = await fetch(BACKEND_CHOOSE(orderId), {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'Accept': 'application/json'},
        body: JSON.stringify({ distributor_code: code, id_distributor: Number(code.replace(/\D/g,'')) || undefined })
      });
      if (!res.ok) {
        const j = await res.json().catch(()=>({}));
        alert('Konfirmasi distributor gagal: ' + (j.error || res.status));
        return;
      }
      cartDistInfo.textContent = 'Distributor dikonfirmasi. Menunggu nomor resi‚Ä¶';
    }

    async function pollDistributorOptions(orderId, timeoutMs = 60000) {
      const start = Date.now();
      while (Date.now() - start < timeoutMs) {
        const url = orderId ? BACKEND_DRAFT_BY_ID(orderId) : BACKEND_DRAFT_LATEST;
        const r = await fetch(url, { headers: {"Accept":"application/json"} });
        if (r.ok) {
          const d = await r.json();
          let opts = Array.isArray(d.distributor_options) ? d.distributor_options : [];
          if (!opts.length && d._raw && Array.isArray(d._raw.distributor_options)) {
            opts = d._raw.distributor_options;
          }
          const ido = d.id_order || d.id || orderId;
          if (ido && opts.length) return { id_order: ido, options: opts };
        }
        await new Promise(s => setTimeout(s, 1500));
      }
      throw new Error("Timeout menunggu opsi distributor.");
    }

    async function pollResi(idOrder, timeoutMs = 180000) {
      const start = Date.now();
      while (Date.now() - start < timeoutMs) {
        const r = await fetch(BACKEND_DRAFT_BY_ID(idOrder), { headers: {"Accept":"application/json"} });
        if (r.ok) {
          const d = await r.json();
          if (d.no_resi) return d;
        }
        await new Promise(s => setTimeout(s, 2000));
      }
      return null;
    }

    function renderResiInCart(info) {
      show(cartResi);
      cartResiInfo.innerHTML = `
        <div class="space-y-1">
          <div>No. Resi: <b class="text-green-800">${info.no_resi}</b></div>
          <div>ETA: <b>${info.eta_delivery_date || "-"}</b></div>
          <div>Total Pembayaran: <b>${rupiah(info.total_pembayaran || 0)}</b></div>
        </div>
      `;
      cartDistInfo.textContent = "Resi diterima. Pengiriman dalam proses.";
    }

    async function checkout() {
      const id_supplier = supplierIdInput.value?.trim();
      if (!id_supplier) { statusEl.textContent = "‚ö†Ô∏è Isi dulu ID Supplier."; return; }

      statusEl.textContent = "‚è≥ Checkout‚Ä¶ mengirim pesanan ke supplier.";
      const res = await fetch(BACKEND_CHECKOUT, {
        method: "POST",
        credentials: "same-origin",
        headers: {"Content-Type":"application/json","Accept":"application/json"},
        body: JSON.stringify({ id_retail: 1, id_supplier })
      });
      const json = await res.json().catch(()=>({}));
      if (!res.ok) {
        statusEl.textContent = "‚ùå Gagal checkout: " + (json.error || res.status);
        return;
      }

      await refreshCart();
      openCart();

      statusEl.textContent = "‚è≥ Menunggu opsi distributor dari supplier‚Ä¶";
      try {
        const { id_order, options } = await pollDistributorOptions();
        window.currentOrderId = id_order;
        showCartDistributor({ orderId: id_order, options, loading: false });
        statusEl.textContent = `‚úì Opsi distributor tersedia untuk Order #${id_order}.`;

        (async () => {
          const info = await pollResi(id_order);
          if (info && info.no_resi) renderResiInCart(info);
        })();

        load();
      } catch (e) {
        statusEl.textContent = "‚ö†Ô∏è " + e.message + " ‚Ä¢ Klik 'Muat ulang' di panel distributor.";
        window.currentOrderId = null;
      }
    }

    // === Events ===
    searchInput.addEventListener("input", render);
    sortSel.addEventListener("change", render);
    refreshBtn.addEventListener("click", load);
    sourceSel.addEventListener("change", () => { CURRENT_SOURCE = sourceSel.value; searchInput.value = ""; renderHeader(); load(); });
    openCartBtn.addEventListener("click", () => { openCart(); refreshCart(); });
    closeCartBtn.addEventListener("click", closeCart);
    clearCartBtn.addEventListener("click", clearCart);
    bulkAddBtn.addEventListener("click", bulkAddSelected);
    checkoutBtn.addEventListener("click", checkout);

    reloadDistBtn?.addEventListener('click', () => { if (window.currentOrderId) fetchAndShowDistributors(window.currentOrderId); });
    reloadDistBtnEmpty?.addEventListener('click', () => { if (window.currentOrderId) fetchAndShowDistributors(window.currentOrderId); });
    confirmDistBtn?.addEventListener('click', () => { if (window.currentOrderId) confirmDistributor(window.currentOrderId); });

    // Initial
    renderHeader();
    load();
  </script>
</body>
</html>