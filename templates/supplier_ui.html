<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Katalog Produk</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @media (min-width: 1024px) {
      .layout { display: grid; grid-template-columns: 260px 1fr; gap: 0; }
      .sidebar { height: 100vh; position: sticky; top: 0; align-self: start; }
    }
    .nav-link.active { background: rgb(243 244 246); font-weight: 600; }
    .skeleton { position: relative; overflow: hidden; background: #f3f4f6; }
    .skeleton::after {
      content: ""; position: absolute; inset: 0; transform: translateX(-100%);
      background: linear-gradient(90deg, rgba(243,244,246,0) 0%, rgba(229,231,235,.9) 50%, rgba(243,244,246,0) 100%);
      animation: shimmer 1.2s infinite;
    }
    @keyframes shimmer { 100% { transform: translateX(100%); } }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="layout">
    <!-- ===== Sidebar ===== -->
    <aside class="sidebar bg-white border-r">
      <div class="p-4 border-b">
        <div class="text-lg font-bold">Retail Dashboard</div>
        <div class="text-xs text-gray-500">Supplier ‚Ä¢ POS ‚Ä¢ Tracking</div>
      </div>

      <nav class="p-2 space-y-1">
        <a href="/ui" class="nav-link flex items-center gap-2 rounded-lg px-3 py-2 hover:bg-gray-50">
          <span>üì¶</span> <span>Supplier</span>
        </a>
        <a href="/ui/tracking" class="nav-link flex items-center gap-2 rounded-lg px-3 py-2 hover:bg-gray-50">
          <span>üöö</span> <span>Tracking</span>
        </a>
        <a href="/ui/pos" class="nav-link flex items-center gap-2 rounded-lg px-3 py-2 hover:bg-gray-50">
          <span>üßæ</span> <span>POS</span>
        </a>
        <a href="/ui/gudang" class="nav-link flex items-center gap-2 rounded-lg px-3 py-2 hover:bg-gray-50">
          <span>üè¨</span> <span>Gudang</span>
        </a>
        <a href="/ui/history" class="nav-link flex items-center gap-2 rounded-lg px-3 py-2 hover:bg-gray-50">
          <span>üìú</span> <span>History</span>
        </a>
      </nav>

      <div class="mt-auto p-4 text-xs text-gray-400">
        ¬© 2025 Retail App
      </div>
    </aside>

    <!-- ===== Main Content (Katalog Supplier) ===== -->
    <main class="min-h-screen">
      <div class="max-w-6xl mx-auto p-6 space-y-4">
        <h1 class="text-2xl font-bold">Katalog Produk</h1>

        <!-- Bar atas -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-3 items-center">
          <div class="flex items-center gap-2">
            <label class="text-sm text-gray-700">Sumber:</label>
            <select id="sourceSel" class="px-3 py-2 rounded-lg border border-gray-300 w-full">
              <option value="supplier">Supplier</option>
              <option value="supplier2">Supplier2</option>
            </select>
          </div>

          <div class="flex items-center gap-2 lg:col-span-2">
            <label for="supplierIdInput" class="text-sm text-gray-700 whitespace-nowrap">ID Supplier:</label>
            <input id="supplierIdInput" type="text" placeholder="contoh: 2"
                   class="px-3 py-2 rounded-lg border border-gray-300 w-full" />
          </div>

          <div class="flex items-center gap-2">
            <button id="refreshBtn" class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 w-full">
              Refresh
            </button>
          </div>

          <div class="lg:col-span-3 flex flex-col sm:flex-row gap-3 mt-2">
            <input id="searchInput" type="search" placeholder="Cari nama / ID / kategori / deskripsi‚Ä¶"
                   class="w-full sm:w-96 px-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring" />
            <select id="sortSel" class="px-3 py-2 rounded-lg border border-gray-300 w-full sm:w-auto">
              <option value="nama_product">Sort: Nama</option>
              <option value="harga">Sort: Harga</option>
              <option value="stok">Sort: Stok</option>
              <option value="expired_date">Sort: Expired</option>
              <option value="kategori">Sort: Kategori</option>
            </select>

            <button id="bulkAddBtn" class="px-3 py-2 rounded-lg bg-amber-600 text-white hover:bg-amber-700">
              Tambah Terpilih
            </button>
          </div>

          <div class="flex items-center gap-2">
            <button id="openCartBtn" class="px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 w-full">
              Keranjang (<span id="cartCount">0</span>)
            </button>
          </div>
        </div>

        <!-- Tabel -->
        <div class="overflow-x-auto bg-white rounded-xl shadow">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-100 text-gray-700" id="thead"></thead>
            <tbody id="tbody" class="divide-y"></tbody>
          </table>
          <div id="tableSkeleton" class="hidden p-4">
            <div class="h-6 w-40 mb-3 skeleton rounded"></div>
            <div class="space-y-2">
              <div class="h-10 skeleton rounded"></div>
              <div class="h-10 skeleton rounded"></div>
              <div class="h-10 skeleton rounded"></div>
            </div>
          </div>
        </div>

        <!-- Status -->
        <p id="status" class="text-sm text-gray-600"></p>
      </div>
    </main>
  </div>

  <!-- Drawer Keranjang -->
  <aside id="cartDrawer" class="fixed right-0 top-0 h-screen w-full sm:w-[440px] bg-white shadow-2xl translate-x-full transition-transform">
    <div class="sticky top-0 z-10 bg-white p-4 border-b flex items-center justify-between">
      <h2 class="text-lg font-semibold">Keranjang</h2>
      <button id="closeCartBtn" class="text-gray-600 hover:text-black">‚úï</button>
    </div>

    <div class="px-4 pb-44 overflow-y-auto h-[calc(100vh-56px)]" id="cartScroll">
      <div class="space-y-2 pt-2" id="cartItems"></div>

      <!-- ===== Pilih Distributor ===== -->
      <section id="cartDist" class="mt-6 hidden">
        <header class="flex items-center justify-between">
          <div>
            <h3 class="text-base font-semibold">Pilih Distributor</h3>
            <p id="cartDistInfo" class="text-xs text-gray-500">Muncul setelah checkout berhasil.</p>
          </div>
          <span id="cartDistOrder" class="text-xs text-gray-500"></span>
        </header>

        <div id="cartDistLoading" class="hidden mt-3 rounded-lg border border-dashed p-4 text-sm text-gray-600">
          Memuat opsi distributor‚Ä¶
        </div>

        <div id="cartDistEmpty" class="hidden mt-3 rounded-lg border border-dashed p-4 text-sm text-gray-600">
          Belum ada opsi distributor untuk order ini.
          <button id="reloadDistBtnEmpty" class="ml-2 underline">Muat ulang</button>
        </div>

        <div id="cartDistOptions" class="mt-3 grid gap-2"></div>

        <div class="mt-3 flex items-center gap-2">
          <button id="reloadDistBtn" class="px-3 py-1.5 rounded-lg border bg-white hover:bg-gray-50">
            Muat ulang
          </button>
          <button id="confirmDistBtn" class="px-3 py-1.5 bg-blue-600 text-white rounded-xl disabled:opacity-50" disabled>
            Konfirmasi Distributor
          </button>
        </div>
      </section>

      <!-- ===== Info Resi ===== -->
      <section id="cartResi" class="hidden mt-6 border rounded-lg p-3 bg-white">
        <h3 class="font-semibold mb-1">Informasi Pengiriman</h3>
        <div id="cartResiInfo" class="text-sm"></div>
      </section>
    </div>

    <div class="fixed right-0 bottom-0 w-full sm:w-[440px] bg-white border-t p-4 space-y-3">
      <div class="flex items-center justify-between">
        <span class="font-medium">Total</span>
        <span id="cartTotal" class="font-semibold">Rp 0</span>
      </div>
      <div class="flex gap-2">
        <button id="clearCartBtn" class="px-3 py-2 rounded-lg border w-1/3">Clear</button>
        <button id="checkoutBtn" class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 w-2/3">Checkout</button>
      </div>
      <small class="text-gray-500 block">Checkout membutuhkan ID Supplier terisi.</small>
    </div>
  </aside>

  <!-- ======= SCRIPT: LOGIC GABUNG ======= -->
  <script>
    // Tandai menu aktif (support /ui dan /ui/supplier)
    (function markActive(){
      const path = window.location.pathname;
      document.querySelectorAll('.nav-link').forEach(a => {
        const href = a.getAttribute('href');
        if (href === '/ui' && (path === '/ui' || path === '/ui/supplier')) a.classList.add('active');
        if (href === path) a.classList.add('active');
      });
    })();

    // ===== CONFIG =====
    const ENDPOINTS = {
      supplier:  "/api/supplier/products",
      supplier2: "/api/supplier2/products",
    };
    const BACKEND_CHECKOUT      = "/api/orders/checkout";
    const BACKEND_DRAFT_LATEST  = "/api/orders/drafts/latest";
    const BACKEND_DRAFT_BY_ID   = (id) => `/api/orders/drafts/${id}`;
    const BACKEND_CHOOSE        = (id) => `/api/orders/drafts/${id}/choose`;

    // ===== DOM =====
    const tbody = document.getElementById("tbody");
    const thead = document.getElementById("thead");
    const tableSkeleton = document.getElementById("tableSkeleton");
    const searchInput = document.getElementById("searchInput");
    const sortSel = document.getElementById("sortSel");
    const statusEl = document.getElementById("status");
    const refreshBtn = document.getElementById("refreshBtn");
    const sourceSel = document.getElementById("sourceSel");
    const supplierIdInput = document.getElementById("supplierIdInput");

    const cartDrawer = document.getElementById("cartDrawer");
    const openCartBtn = document.getElementById("openCartBtn");
    const closeCartBtn = document.getElementById("closeCartBtn");
    const cartItemsEl = document.getElementById("cartItems");
    const cartTotalEl = document.getElementById("cartTotal");
    const cartCountEl = document.getElementById("cartCount");
    const clearCartBtn = document.getElementById("clearCartBtn");
    const checkoutBtn = document.getElementById("checkoutBtn");
    const bulkAddBtn = document.getElementById("bulkAddBtn");

    const cartDist = document.getElementById("cartDist");
    const cartDistOrder = document.getElementById("cartDistOrder");
    const cartDistOptions = document.getElementById("cartDistOptions");
    const cartDistInfo = document.getElementById("cartDistInfo");
    const cartDistLoading = document.getElementById("cartDistLoading");
    const cartDistEmpty = document.getElementById("cartDistEmpty");
    const reloadDistBtn = document.getElementById("reloadDistBtn");
    const reloadDistBtnEmpty = document.getElementById("reloadDistBtnEmpty");
    const confirmDistBtn = document.getElementById("confirmDistBtn");

    const cartResi = document.getElementById("cartResi");
    const cartResiInfo = document.getElementById("cartResiInfo");

    // ===== STATE =====
    let DATA = [];
    let CACHE_LAST_GOOD = [];
    let CURRENT_SOURCE = sourceSel.value;
    window.currentOrderId = null;

    // --- Race control untuk load() ---
    let lastLoadId = 0;
    let currentAbort = null;

    const rupiah = n =>
      new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR", maximumFractionDigits: 0 })
        .format(n ?? 0);

    // ---------- Catalog ----------
    function renderHeader() {
      const isSupplier2 = CURRENT_SOURCE === "supplier2";
      thead.innerHTML = `
        <tr>
          <th class="p-3 text-center"><input id="chkAll" type="checkbox" /></th>
          <th class="text-left p-3">ID</th>
          <th class="text-left p-3">Nama</th>
          ${isSupplier2 ? '<th class="text-left p-3">Kategori</th>' : ''}
          <th class="text-right p-3">Harga</th>
          <th class="text-right p-3">Stok</th>
          ${isSupplier2 ? '<th class="text-left p-3">Deskripsi</th>' : '<th class="text-left p-3">Expired</th>'}
          <th class="text-center p-3 w-28">Qty</th>
          <th class="text-center p-3">Aksi</th>
        </tr>
      `;
      setTimeout(() => {
        const chkAll = document.getElementById("chkAll");
        if (chkAll) chkAll.addEventListener("change", (e) => {
          document.querySelectorAll(".rowChk").forEach(c => c.checked = e.target.checked);
        });
      }, 0);
    }

    function render() {
      const q = searchInput.value.trim().toLowerCase();
      let rows = DATA.filter(d =>
        (String(d.nama_product || "").toLowerCase().includes(q)) ||
        (String(d.id_product || "").toLowerCase().includes(q)) ||
        (String(d.kategori || "").toLowerCase().includes(q)) ||
        (String(d.deskripsi || "").toLowerCase().includes(q)) ||
        (String(d.expired_date || "").toLowerCase().includes(q))
      );

      const key = sortSel.value;
      rows.sort((a,b) => {
        if (["harga","stok"].includes(key)) return (a[key] ?? 0) - (b[key] ?? 0);
        return String(a[key] ?? "").localeCompare(String(b[key] ?? ""));
      });

      const isSupplier2 = CURRENT_SOURCE === "supplier2";
      tbody.innerHTML = rows.map(item => `
        <tr class="hover:bg-gray-50">
          <td class="p-3 text-center">
            <input class="rowChk" type="checkbox" data-id="${item.id_product}">
          </td>
          <td class="p-3 font-mono">${item.id_product ?? ""}</td>
          <td class="p-3">${item.nama_product ?? ""}</td>
          ${isSupplier2 ? `<td class="p-3">${item.kategori ?? "-"}</td>` : ""}
          <td class="p-3 text-right">${rupiah(item.harga)}</td>
          <td class="p-3 text-right">${item.stok ?? 0}</td>
          ${isSupplier2
            ? `<td class="p-3">${item.deskripsi ?? "-"}</td>`
            : `<td class="p-3">${item.expired_date ?? "-"}</td>`}
          <td class="p-3 text-center">
            <input type="number" min="1" max="${item.stok ?? 999999}" value="1"
                   class="qtyInput w-20 px-2 py-1 border rounded"
                   data-id="${item.id_product}">
          </td>
          <td class="p-3 text-center">
            <button class="px-3 py-1.5 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700"
              onclick='addToCart(${JSON.stringify(item.id_product)}, ${JSON.stringify(item.nama_product)}, ${JSON.stringify(item.harga)}, ${JSON.stringify(item.stok)}, getQty("${item.id_product}"))'>
              Tambah
            </button>
          </td>
        </tr>
      `).join("");

      statusEl.textContent = `${rows.length} item ditampilkan dari sumber ${CURRENT_SOURCE}${q ? ` (filter: "${q}")` : ""}`;
    }

    async function load() {
      tableSkeleton.classList.remove('hidden');
      if (currentAbort) { try { currentAbort.abort(); } catch (_) {} }
      const aborter = new AbortController();
      currentAbort = aborter;
      const myLoadId = ++lastLoadId;

      try {
        const url = ENDPOINTS[CURRENT_SOURCE];
        const res = await fetch(url, { headers: { "Accept": "application/json" }, signal: aborter.signal });
        const json = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(json?.error ? `${json.error}: ${json.detail || ""}` : `HTTP ${res.status}`);

        if (myLoadId !== lastLoadId) return;

        let incoming = Array.isArray(json) ? json : (json.data || json.items || json.products || []);
        if (!Array.isArray(incoming)) incoming = [];
        DATA = incoming;
        CACHE_LAST_GOOD = incoming;
        renderHeader();
        render();
        statusEl.textContent = `Data termuat dari sumber ${CURRENT_SOURCE} (${DATA.length} item).`;
      } catch (e) {
        if (myLoadId !== lastLoadId) return;
        console.error(e);
        statusEl.textContent = "Gagal memuat data: " + (e?.message || e);
        if (CACHE_LAST_GOOD.length) {
          DATA = CACHE_LAST_GOOD;
          renderHeader();
          render();
        } else {
          DATA = [];
          renderHeader();
          tbody.innerHTML = '<tr><td class="p-4 text-center text-gray-500" colspan="9">Tidak ada data.</td></tr>';
        }
      } finally {
        if (myLoadId === lastLoadId) tableSkeleton.classList.add('hidden');
      }
      await refreshCart();
    }

    // ---------- Helpers ----------
    function getQty(id) {
      const el = document.querySelector(`.qtyInput[data-id="${CSS.escape(String(id))}"]`);
      let q = parseInt(el?.value || "1", 10);
      if (isNaN(q) || q <= 0) q = 1;
      const max = parseInt(el?.getAttribute("max") || "0", 10);
      if (max && q > max) q = max;
      return q;
    }
    function findItemById(id) {
      return DATA.find(d => String(d.id_product) === String(id));
    }

    // ---------- Cart ----------
    function openCart() { cartDrawer.style.transform = "translateX(0)"; }
    function closeCart() { cartDrawer.style.transform = "translateX(100%)"; }

    async function refreshCart() {
      const res = await fetch("/api/cart/", { credentials: "same-origin", headers: { "Accept": "application/json" }});
      const json = await res.json().catch(() => ({items:[], total:0}));
      const items = json.items || [];
      cartItemsEl.innerHTML = items.map(it => `
        <div class="flex items-center justify-between border rounded-lg p-2">
          <div class="min-w-0">
            <div class="font-medium truncate">${it.nama_product}</div>
            <div class="text-xs text-gray-500">ID: ${it.id_product} ‚Ä¢ Stok: ${it.stok}</div>
            <div class="text-xs">${rupiah(it.harga)} √ó ${it.qty}</div>
          </div>
          <div class="flex items-center gap-1">
            <button class="px-2 py-1 border rounded" onclick='updateQty(${JSON.stringify(it.id_product)}, ${Math.max(0,(it.qty-1))})'>‚àí</button>
            <span class="w-6 text-center">${it.qty}</span>
            <button class="px-2 py-1 border rounded" onclick='updateQty(${JSON.stringify(it.id_product)}, ${it.qty+1})'>+</button>
          </div>
        </div>
      `).join("") || '<div class="text-sm text-gray-500">Keranjang kosong.</div>';
      cartTotalEl.textContent = rupiah(json.total || 0);
      cartCountEl.textContent = items.reduce((a,b)=>a+(b.qty||0),0);
    }

    async function addToCart(id_product, nama_product, harga, stok, qty=1) {
      const res = await fetch("/api/cart/add", {
        method: "POST",
        credentials: "same-origin",
        headers: {"Content-Type":"application/json","Accept":"application/json"},
        body: JSON.stringify({ id_product, nama_product, harga, stok, qty })
      });
      if (!res.ok) {
        const e = await res.json().catch(()=>({}));
        statusEl.textContent = "Gagal tambah ke keranjang: " + (e.error || res.status);
        return;
      }
      await refreshCart();
      statusEl.textContent = `Ditambahkan: ${nama_product} (x${qty})`;
      openCart();
    }

    async function bulkAddSelected() {
      const ids = [...document.querySelectorAll(".rowChk:checked")].map(c => c.dataset.id);
      if (!ids.length) { statusEl.textContent = "Pilih dulu itemnya."; return; }
      const items = ids.map(id => {
        const it = findItemById(id) || {};
        return {
          id_product: it.id_product,
          nama_product: it.nama_product,
          harga: it.harga,
          stok: it.stok,
          qty: getQty(id)
        };
      });

      const res = await fetch("/api/cart/bulk_add", {
        method: "POST",
        credentials: "same-origin",
        headers: {"Content-Type":"application/json","Accept":"application/json"},
        body: JSON.stringify({ items })
      });
      const json = await res.json().catch(()=>({}));
      if (!res.ok) { statusEl.textContent = "Gagal tambah massal: " + (json.error || res.status); return; }
      await refreshCart();
      statusEl.textContent = `Ditambahkan ${items.length} item ke keranjang.`;
      openCart();
    }

    async function updateQty(id_product, qty) {
      const res = await fetch("/api/cart/update", {
        method: "POST",
        credentials: "same-origin",
        headers: {"Content-Type":"application/json","Accept":"application/json"},
        body: JSON.stringify({ id_product, qty })
      });
      if (!res.ok) return;
      await refreshCart();
    }

    async function clearCart() {
      await fetch("/api/cart/clear", { method: "POST", credentials: "same-origin" });
      await refreshCart();
    }

    // ---------- UI helper Distributor ----------
    const show = el => el.classList.remove('hidden');
    const hide = el => el.classList.add('hidden');

    function distCardHTML(dist) {
      const code = dist.code || dist.id_distributor || '';
      const name = dist.name || dist.nama_distributor || '-';
      const service = dist.service || dist.layanan || 'Reguler';
      const fee = dist.fee ?? dist.harga_pengiriman ?? dist.harga ?? 0;
      const eta = dist.eta_text ?? dist.estimasi ?? '-';
      const note = dist.note || '';
      const feeFmt = new Intl.NumberFormat('id-ID').format(fee);

      return `
        <label class="flex gap-3 items-start rounded-xl border p-3 hover:bg-gray-50 cursor-pointer">
          <input type="radio" name="distChoice" value="${code}" class="mt-1" />
          <div class="flex-1">
            <div class="flex items-center justify-between">
              <p class="font-medium">${name}</p>
              <p class="text-sm font-semibold">Rp ${feeFmt}</p>
            </div>
            <p class="text-sm text-gray-600">${service} ‚Ä¢ ${eta}</p>
            ${note ? `<p class="text-xs text-gray-500 mt-1">${note}</p>` : ''}
            <p class="text-xs text-gray-500">Kode: ${code}</p>
          </div>
        </label>
      `;
    }

    function renderDistributors(options = []) {
      cartDistOptions.innerHTML = options.map(o => distCardHTML(o)).join('');
      const radios = cartDistOptions.querySelectorAll('input[type="radio"]');
      confirmDistBtn.disabled = true;
      radios.forEach(r => r.addEventListener('change', () => { confirmDistBtn.disabled = false; }));
    }

    function showCartDistributor({ orderId, options, loading }) {
      show(cartDist);
      cartDistOrder.textContent = orderId ? `Order #${orderId}` : '';
      cartDistInfo.textContent = 'Pilih salah satu opsi untuk melanjutkan.';
      if (loading) {
        show(cartDistLoading); hide(cartDistEmpty); cartDistOptions.innerHTML = '';
        confirmDistBtn.disabled = true; return;
      }
      hide(cartDistLoading);
      if (!options || !options.length) {
        show(cartDistEmpty); cartDistOptions.innerHTML = ''; confirmDistBtn.disabled = true;
      } else {
        hide(cartDistEmpty); renderDistributors(options);
      }
    }

    async function fetchAndShowDistributors(orderId) {
      showCartDistributor({ orderId, loading: true });
      try {
        const res = await fetch(BACKEND_DRAFT_BY_ID(orderId), { headers: {"Accept":"application/json"} });
        const d = await res.json();
        let opts = Array.isArray(d.distributor_options) ? d.distributor_options : [];
        if (!opts.length && d._raw && Array.isArray(d._raw.distributor_options)) {
          opts = d._raw.distributor_options;
        }
        showCartDistributor({ orderId, options: opts, loading: false });
      } catch (e) {
        showCartDistributor({ orderId, options: [], loading: false });
        alert('Gagal memuat opsi distributor.');
      }
    }

    async function confirmDistributor(orderId) {
      const checked = document.querySelector('#cartDistOptions input[type="radio"]:checked');
      if (!checked) return;
      const code = checked.value;
      const res = await fetch(BACKEND_CHOOSE(orderId), {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'Accept': 'application/json'},
        body: JSON.stringify({ distributor_code: code, id_distributor: Number(code.replace(/\D/g,'')) || undefined })
      });
      if (!res.ok) {
        const j = await res.json().catch(()=>({}));
        alert('Konfirmasi distributor gagal: ' + (j.error || res.status));
        return;
      }
      cartDistInfo.textContent = 'Distributor dikonfirmasi. Menunggu nomor resi‚Ä¶';
    }

    // ---------- Alur draft / polling ----------
    async function pollDistributorOptions(orderId, timeoutMs = 60000) {
      const start = Date.now();
      while (Date.now() - start < timeoutMs) {
        const url = orderId ? BACKEND_DRAFT_BY_ID(orderId) : BACKEND_DRAFT_LATEST;
        const r = await fetch(url, { headers: {"Accept":"application/json"} });
        if (r.ok) {
          const d = await r.json();
          let opts = Array.isArray(d.distributor_options) ? d.distributor_options : [];
          if (!opts.length && d._raw && Array.isArray(d._raw.distributor_options)) {
            opts = d._raw.distributor_options;
          }
          const ido = d.id_order || d.id || orderId;
          if (ido && opts.length) return { id_order: ido, options: opts };
        }
        await new Promise(s => setTimeout(s, 1500));
      }
      throw new Error("Timeout menunggu opsi distributor.");
    }

    async function pollResi(idOrder, timeoutMs = 180000) {
      const start = Date.now();
      while (Date.now() - start < timeoutMs) {
        const r = await fetch(BACKEND_DRAFT_BY_ID(idOrder), { headers: {"Accept":"application/json"} });
        if (r.ok) {
          const d = await r.json();
          if (d.no_resi) return d;
        }
        await new Promise(s => setTimeout(s, 2000));
      }
      return null;
    }

    function renderResiInCart(info) {
      show(cartResi);
      cartResiInfo.innerHTML = `
        <div>No. Resi: <b>${info.no_resi}</b></div>
        <div>ETA: ${info.eta_delivery_date || "-"}</div>
        <div>Total Pembayaran: ${rupiah(info.total_pembayaran || 0)}</div>
      `;
      cartDistInfo.textContent = "Resi diterima.";
    }

    // ---------- Checkout ----------
    async function checkout() {
      const id_supplier = supplierIdInput.value?.trim();
      if (!id_supplier) { statusEl.textContent = "Isi dulu ID Supplier."; return; }

      statusEl.textContent = "Checkout‚Ä¶ mengirim ke supplier.";
      const res = await fetch(BACKEND_CHECKOUT, {
        method: "POST",
        credentials: "same-origin",
        headers: {"Content-Type":"application/json","Accept":"application/json"},
        body: JSON.stringify({ id_retail: 1, id_supplier })
      });
      const json = await res.json().catch(()=>({}));
      if (!res.ok) {
        statusEl.textContent = "Gagal checkout: " + (json.error || res.status);
        return;
      }

      await refreshCart();
      openCart();

      statusEl.textContent = "Menunggu opsi distributor dari supplier‚Ä¶";
      try {
        const { id_order, options } = await pollDistributorOptions();
        window.currentOrderId = id_order;
        showCartDistributor({ orderId: id_order, options, loading: false });
        statusEl.textContent = `Opsi distributor tersedia untuk Order #${id_order}.`;

        (async () => {
          const info = await pollResi(id_order);
          if (info && info.no_resi) renderResiInCart(info);
        })();

        load(); // refresh katalog setelah sukses
      } catch (e) {
        statusEl.textContent = e.message + " ‚Ä¢ Klik 'Muat ulang' di panel distributor.";
        window.currentOrderId = null;
      }
    }

    // ---------- Events ----------
    searchInput.addEventListener("input", render);
    sortSel.addEventListener("change", render);
    refreshBtn.addEventListener("click", load);
    sourceSel.addEventListener("change", () => { CURRENT_SOURCE = sourceSel.value; searchInput.value = ""; renderHeader(); load(); });
    openCartBtn.addEventListener("click", () => { openCart(); refreshCart(); });
    closeCartBtn.addEventListener("click", closeCart);
    clearCartBtn.addEventListener("click", clearCart);
    bulkAddBtn.addEventListener("click", bulkAddSelected);
    checkoutBtn.addEventListener("click", checkout);

    document.getElementById('reloadDistBtn')?.addEventListener('click', () => {
      if (window.currentOrderId) fetchAndShowDistributors(window.currentOrderId);
    });
    document.getElementById('reloadDistBtnEmpty')?.addEventListener('click', () => {
      if (window.currentOrderId) fetchAndShowDistributors(window.currentOrderId);
    });
    document.getElementById('confirmDistBtn')?.addEventListener('click', () => {
      if (window.currentOrderId) confirmDistributor(window.currentOrderId);
    });

    // init
    renderHeader();
    load();
  </script>
</body>
</html>
